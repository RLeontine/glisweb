<?xml version="1.0" encoding="UTF-8"?>
<project name="DEPLOY" default="default">
    
    <!-- inclusione file proprietà -->
    <property file="../../../usr/deploy/phing/build.properties" />

    <!-- proprietà derivate -->
    <property name="dst.dir" value="${dst.fld}/${dst.stg}" />
    <property name="src.dir" value="${src.fld}/${src.stg}" />

    <!-- fileset del progetto -->
    <fileset dir="${src.stg}" id="files.project" expandsymboliclinks="true">

        <!-- file inclusi -->
        <include name="_**/*" />
        <include name="etc/**/*" />
        <include name="mod/**/*" />
        <include name="src/**/*" />
        <include name="usr/**/*" />
        <include name=".htaccess" />
        <include name="composer.json" />

        <!-- file esclusi -->
        <exclude name="robots.txt" />
        <exclude name="build.properties" />

    </fileset>

    <!-- git commit & push -->
    <target name="git.push">

        <!-- se c'è un repository di progetto -->
        <if>
            <available file="${src.dir}/.git/" />
            <then>

                <!-- se c'è un avanzamento di versione -->
                <if>
                    <equals arg1="${prj.inc}" arg2="" />
                    <then>

                        <!-- messaggi -->
                        <echo msg="nessun push richiesto in caso di deploy senza avanzamento di versione" />

                    </then>
                    <else>

                        <!-- se il repository non è quello di sviluppo principale -->
                        <if>
                            <equals arg1="${prj.git}" arg2="framework" />
                            <then>

                                <!-- messaggi -->
                                <echo msg="effettuare manualmente il push sul repository standard" />

                            </then>
                            <else>

                                <!-- passo al ramo master -->
                                <echo msg="git checkout..." />
                                <exec command="cd ${src.dir}/ &amp;&amp; git checkout master" />

                                <!-- effettuo il commit delle eventuali modifiche in sospeso -->
                                <echo msg="git commit..." />
                                <exec command="cd ${src.dir}/ &amp;&amp; git add . &amp;&amp; git commit -m 'distribuzione della versione ${version}'" />

                                <!-- applico il tag di versione -->
                                <echo msg="git tag..." />
                                <echo msg="tag: v${rev.num}" />
                                <exec command="cd ${src.dir}/ &amp;&amp; git tag -a 'v${rev.num}' -m 'versione ${rev.num}'" />

                                <!-- faccio il push pubblicando il tag -->
                                <echo msg="git push..." />
                                <exec command="cd ${src.dir}/ &amp;&amp; git push --follow-tags" />

                            </else>
                        </if>

                    </else>
                </if>
            </then>
            <else>

                <!-- messaggi -->
                <echo msg="nessun repository git presente per il progetto" />

            </else>
        </if>
    </target>

    <!-- notifica via Slack -->
    <target name="notify.slack">

        <!-- messaggi -->
        <echo msg="invio la notifica via Slack..." />

        <!-- se Slack è collegato -->
        <if>
            <equals arg1="${slck.sa}" arg2="" />
            <then>

                <!-- messaggi -->
                <echo msg="Slack non configurato" />

            </then>
            <else>

                <!-- invio il messaggio-->
                <exec command="va.slack.msg.sh ${slack.sa} ${slack.sb} ${slack.sc} 'abbiamo rilasciato un aggiornamento in ${dst.stg} su ${dst.url}, vi preghiamo di prendere visione'" />

            </else>
        </if>
    </target>

    <!-- target di default -->
    <target name="default">

        <!-- messaggi -->
        <echo msg="avvio operazioni con procedura standard..." />

        <!-- passo alla richiesta interattiva della tipologia di deploy -->
        <phingcall target="dist.interactive" />

    </target>

    <!-- avanzamento di versione -->
    <target name="version.increment">

        <!-- se è dichiarato il tipo di deploy o no -->
        <if>
            <equals arg1="${prj.inc}" arg2="" />
            <then>

                <!-- messaggi -->
                <echo msg="deploy senza incremento di versione" />

            </then>
            <else>

                <!-- se non esiste il file di versione all'interno del progetto -->
                <if>
                    <not>
                        <available file="${src.dir}/etc/version.conf"/>
                    </not>
                    <then>

                        <!-- messaggi -->
                        <echo msg="creo e inizializzo il file: ${src.dir}/etc/version.conf" />

                        <!-- creo la cartella e il file di versione -->
                        <mkdir dir="${src.dir}/etc" />
                        <touch file="${src.dir}/etc/version.conf"/>
                        <echo msg="0.0.0" file="${src.dir}/etc/version.conf" />

                    </then>
                    <else>

                        <!-- messaggi -->
                        <echo msg="trovato file: ${src.dir}/etc/version.conf" />

                    </else>
                </if>

                <!-- incremento la versione in base al tipo di deploy -->
                <version releasetype="${prj.inc}" file="${src.dir}/etc/version.conf" property="rev.num"/>

            </else>
        </if>
    </target>

    <!-- distribuzione via rsync in locale -->
    <target name="dist.rsync.local">

        <!-- abilito la pagina 503 -->
        <mkdir dir="${dst.dir}/tmp" />
        <touch file="${dst.dir}/tmp/.upgrade" />

        <!-- sincronizzo le cartelle -->
        <echo msg="rsync ${src.dir} -> ${dst.dir}" />
        <filesync sourcedir="${src.dir}/" destinationdir="${dst.dir}/" exclude="tmp,var,usr,.git,.gitignore,robots.txt,sitemap.xml,sitemap.csv,googlemerchant.xml,googlereviews.xml" delete="true" verbose="false" />

        <!-- disabilito la pagina 503 -->
        <delete file="${dst.dir}/tmp/.upgrade" />

    </target>

    <!-- distribuzione interattiva (chiede il tipo di release -->
    <target name="dist.interactive">

        <!-- messaggi -->
        <echo msg="ATTENZIONE! inserire il tipo di release (le etichette sono case sensitive)" />
        <echo msg="ATTENZIONE! se non si desidera aumentare la versione, lasciare il campo in bianco" />

        <!-- richiedo il tipo di deploy -->
        <propertyprompt propertyName="prj.inc" defaultValue="" promptText="tipo di distribuzione (Major|Minor|Bugfix)" />

        <!-- passo all'esecuzione del deploy -->
        <phingcall target="dist.exec" />

    </target>

    <!-- distribuzione major -->
    <target name="dist.major">

        <!-- forzo il tipo di avanzamento a Major -->
        <property name="prj.inc" value="Major" override="true" />

        <!-- messaggi -->
        <echo msg="impostato avanzamento: ${prj.inc}" />

        <!-- passo all'esecuzione del deploy -->
        <phingcall target="dist.exec" />

    </target>

    <!-- distribuzione minor -->
    <target name="dist.minor">

        <!-- forzo il tipo di avanzamento a Minor -->
        <property name="prj.inc" value="Minor" override="true" />

        <!-- messaggi -->
        <echo msg="impostato avanzamento: ${prj.inc}" />

        <!-- passo all'esecuzione del deploy -->
        <phingcall target="dist.exec" />

    </target>

    <!-- distribuzione bugfix -->
    <target name="dist.bugfix">

        <!-- forzo il tipo di avanzamento a Bugfix -->
        <property name="prj.inc" value="Bugfix" override="true" />

        <!-- messaggi -->
        <echo msg="impostato avanzamento: ${prj.inc}" />

        <!-- passo all'esecuzione del deploy -->
        <phingcall target="dist.exec" />

    </target>

    <!-- esecuzione del deploy -->
    <target name="dist.exec" depends="version.increment,git.push">

        <!-- messaggi -->
        <echo msg="progetto: ${prj.nme}" />
        <echo msg="distribuzione da ${src.stg} a ${dst.stg}..." />
        <echo msg="licenza: ${lcs.key}" />
        <echo msg="tipo di release: ${prj.inc}" />
        <echo msg="versione: ${rev.num}" />

        <!-- se la destinazione è locale oppure remota -->
        <if>
            <equals arg1="${dst.hst}" arg2="" />
            <then>

                <!-- messaggi -->
                <echo msg="deploy locale su: ${dst.dir}" />

                <!-- esecuzione del deploy tramite rsync -->
                <phingcall target="dist.rsync.local" />

            </then>
            <else>

                <!-- messaggi -->
                <echo msg="deploy remoto su: ${dst.hst}${dst.dir}" />

            </else>
        </if>

        <!-- se è settato un URL del progetto di destinazione -->
        <if>
            <equals arg1="${dst.url}" arg2="" />
            <then>

                <!-- messaggi -->
                <echo msg="URL del progetto di destinazione non settato!" />

            </then>
            <else>

                <!-- notifica su Slack -->
                <phingcall target="notify.slack" />

            </else>
        </if>

    </target>

</project>
